name: Housework Master CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      run_e2e:
        description: Run E2E tests
        required: false
        default: true
        type: boolean
      deploy:
        description: Deploy to Production
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write

jobs:
  # 1. Testy jednostkowe
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-22.04
    environment: integration
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      PUBLIC_SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Run Vitest
        run: npm run test:run

  # 2. Próbne budowanie (sprawdza czy kod się kompiluje i typy TS są ok)
  build-check:
    name: Build Check
    runs-on: ubuntu-22.04
    environment: integration
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      PUBLIC_SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Build project
        run: npm run build

  # 3. Testy E2E (Playwright) - najcięższe, więc warto je wyodrębnić
  e2e-test:
    name: E2E Tests
    # Uruchom na PR lub manualnie, lub po pomyślnym buildzie na master (opcjonalnie)
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    needs: [build-check] # Czekamy, aż build przejdzie, żeby nie marnować zasobów
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    environment: integration
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      PUBLIC_SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      # Playwright potrzebuje URL lub musi odpalić serwer sam (via playwright.config.ts webServer)
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test:e2e

      # Upload raportu tylko gdy testy padną
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # 4. Deployment
  deploy:
    name: Deploy (Production)
    needs: [unit-test, build-check, e2e-test]

    if: ${{ github.ref == 'refs/heads/master' && inputs.deploy == true }}
    runs-on: ubuntu-22.04

    environment: production
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      PUBLIC_SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      
      - name: Build for Production
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=housework-master
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}